# PRD v1（评审草案）
## 项目
T-20260211-100 学习成长系统重构（学生端 + 家长端）

## 审查索引（快速定位）
- PRD→模块：见 **3. 功能模块拆解**（3.1~3.5）
- PRD→模块DoD：见 **3.x.1 DoD（可验收标准）**
- PRD→数据结构：见 **4. 数据结构草案** 与 **4.1 字段级数据字典**
- PRD→权限矩阵：见 **2. 用户与权限矩阵** 与 **4.2 最小权限边界说明**
- PRD→监督策略：见 **5. 监督策略（可执行规则）** + **5.1/5.2/5.3 反误伤机制与流程示例**
- PRD→A/B测试点：见 **6. A/B测试点**
- PRD→里程碑排期：见 **7. 里程碑排期（评审版）**

## 1. 目标与范围
### 1.1 目标
- 让孩子“看得见进步、做得到计划、做得到自律、拿得到激励”。
- 让家长“可配置、可监督、可审核、可追溯”。

### 1.2 本期范围（MVP+）
1) 学习看板：学科进度/成绩/作业完成图表
2) 计划与执行：20/30天计划 + 每日任务
3) 监督机制：计时 + 随机在岗验证 + 拍照提交 + 家长审核
4) 积分奖惩：积分账户 + 兑换商城 + 奖惩流水
5) 成长档案：身高体重/照片/里程碑

### 1.3 不在本期
- AI自动批改主观题（先人工审核）
- 硬件摄像头持续监控（仅做可选提醒与随机验证）

---

## 2. 用户与权限矩阵
| 角色 | 查看学习数据 | 制定/改计划 | 开始/结束计时 | 提交作业 | 审核作业 | 配置监督规则 | 配置积分商城 | 管理成长档案 |
|---|---|---|---|---|---|---|---|---|
| 学生 | ✅ | 仅提案（需家长确认） | ✅ | ✅ | ❌ | ❌ | ❌ | 仅查看 |
| 家长 | ✅ | ✅ | ✅（代操作） | ✅（代提交） | ✅ | ✅ | ✅ | ✅ |

关键控制：
- 学生端无“系统配置”入口。
- 家长端可强制计划锁定（锁定后学生不可改）。

---

## 3. 功能模块拆解
## 3.1 学习看板（学生端/家长端）
- 指标：
  - 学科完成率（本周/本月）
  - 成绩趋势（折线）
  - 作业完成及时率（柱状）
  - 错题改正率（环形）
- 图表建议：ECharts（折线/柱状/雷达/环形）

### 3.1.1 DoD（可验收标准）
- 输入：`plan_v4`（任务状态）、`score_v1`（成绩）、`checkin_v2`（提交时间）、`points_v1`（奖惩）
- 输出：看板四类图表 + 指标卡（完成率/及时率/改正率）
- 成功判定：
  1) 图表可渲染且时间维度切换（周/月）生效；
  2) 指标值与源数据抽样核对误差=0（同口径）。
- 失败处理：
  - 数据缺失时显示“暂无数据”占位；
  - 数据异常时记录日志并回退到最近一次可用快照。
- 验收指标（量化）：首屏图表渲染时间 ≤ 2 秒（近7天数据量场景）。

## 3.2 计划与执行
- 计划粒度：假期总计划（20/30天）+ 日计划（任务清单）
- 规则：
  - 每日任务上限（家长配置）
  - 未完成自动顺延
  - 计划变更要留痕（谁、何时、改了什么）

### 3.2.1 DoD（可验收标准）
- 输入：家长配置（周期/每日上限）、题目或任务池、历史完成状态
- 输出：`plan_v4` 计划结果（日任务列表+顺延+变更日志）
- 成功判定：
  1) 20/30天切换后计划总量按规则重算；
  2) 未完成任务次日可见“顺延”标记；
  3) 计划修改均有`changeLogs`记录。
- 失败处理：
  - 生成失败时保留旧计划并提示重试；
  - 参数非法（如每日上限=0）阻止保存并提示。
- 验收指标（量化）：计划生成成功率 ≥ 99%，单次生成耗时 ≤ 1 秒（本地MVP数据量）。

## 3.3 监督机制
- 计时：开始/暂停/继续/结束，记录有效学习时长
- 随机在岗验证（反摸鱼）：
  - 启动后按随机间隔弹验证（如 8~15 分钟）
  - 验证形式：小题目/知识点判断/简短打字确认
  - 规则：超时未响应记“可疑离岗”
- 拍照提交：作业完成拍照 + 备注
- 家长审核：通过/驳回 + 批注 + 要求重做

### 3.3.1 DoD（可验收标准）
- 输入：计时会话、随机验证规则、作业照片、家长审核操作
- 输出：`timer_v2`会话记录 + `supervision_v1`事件 + `checkin_v2`审核结果
- 成功判定：
  1) 计时四状态（开始/暂停/继续/结束）可闭环；
  2) 随机验证按区间触发，事件被记录；
  3) 作业提交后可被家长通过/驳回并留批注。
- 失败处理：
  - 拍照上传失败自动重试1次，仍失败则进入待补提状态；
  - 验证弹窗失败则重发一次并记系统异常标签。
- 验收指标（量化）：随机验证触发命中率 ≥ 95%，审核链路完成率 ≥ 99%。

## 3.4 积分奖惩与商城
- 积分来源：按时完成、连续打卡、成绩提升、优秀行为
- 扣分来源：拖延、未按时提交、审核驳回后未整改
- 商城：
  - 小奖励：看电视30分钟、游戏20分钟、美食券
  - 大奖励：周末外出、目标达成礼物
- 兑换流程：学生发起 -> 家长审批 -> 核销

### 3.4.1 DoD（可验收标准）
- 输入：任务完成事件、审核结果、奖惩规则、兑换申请
- 输出：积分余额、奖惩流水、订单状态（pending/approved/rejected/redeemed）
- 成功判定：
  1) 每笔加扣分均产生不可篡改流水；
  2) 余额变化=流水累计；
  3) 兑换必须经过家长审批才能核销。
- 失败处理：
  - 规则冲突时按“家长显式配置优先”并记录告警；
  - 余额不足时阻止下单并给出提示。
- 验收指标（量化）：积分账实一致率 100%，兑换审批平均处理时长 ≤ 24h（业务目标）。

## 3.5 成长档案
- 基础：年龄、年级、身高、体重
- 里程碑：获奖/进步事件/改错记录
- 相册：学习与生活照片（按月展示）

### 3.5.1 DoD（可验收标准）
- 输入：成长数据（身高/体重）、里程碑文本、照片素材
- 输出：成长时间线、月度相册、基础信息卡
- 成功判定：
  1) 时间线按时间排序展示；
  2) 照片可按月份筛选；
  3) 学生仅可查看，家长可新增/编辑/删除。
- 失败处理：
  - 图片过大/格式不合法时阻止上传并提示；
  - 删除操作要求二次确认并写审计日志。
- 验收指标（量化）：成长记录检索命中率 100%，照片上传成功率 ≥ 98%。

---

## 4. 数据结构草案（前端 localStorage 命名，可平滑迁移后端）
```json
profile_v1: {
  "student": {"nameMasked":"路*昊","age":10,"grade":"四年级"},
  "growth": {"heightCm":140,"weightKg":34,"updatedAt":""}
}

plan_v4: {
  "cycleDays": 20,
  "dailyCap": 4,
  "lockedByParent": true,
  "days": [
    {"day":1,"tasks":[{"id":"t1","subject":"数学","title":"...","status":"todo|done|review_reject"}]}
  ],
  "changeLogs": [{"by":"parent|student","at":"","diff":"..."}]
}

timer_v2: {
  "sessions": [
    {"taskId":"t1","subject":"数学","startAt":"","endAt":"","activeMs":1800000,"interruptions":1}
  ]
}

checkin_v2: {
  "items": [
    {"taskId":"t1","photo":"dataURL","note":"","submittedAt":"","review":"pending|approved|rejected","reviewNote":""}
  ]
}

supervision_v1: {
  "rules": {"enabled":true,"minGapMin":8,"maxGapMin":15,"timeoutSec":60},
  "events": [
    {"sessionId":"s1","type":"challenge","shownAt":"","answered":true,"latencySec":18,"result":"pass|fail|timeout"}
  ]
}

points_v1: {
  "balance": 120,
  "ledger": [{"at":"","delta":10,"reason":"按时完成日计划"}],
  "shop": [{"id":"r1","name":"看电视30分钟","cost":30,"enabled":true}],
  "orders": [{"id":"o1","rewardId":"r1","status":"pending|approved|rejected|redeemed"}]
}

score_v1: {
  "records": [{"subject":"数学","score":92,"at":"","source":"周测"}],
  "mistakeFix": [{"mistakeId":"m1","fixed":true,"verifiedByParent":true}]
}
```

### 4.1 字段级数据字典（关键对象）
> 统一审计字段约定：`createdAt` / `updatedAt` / `by` / `version` 必填；主键 `id` 必填。

#### 4.1.1 plan_v4（计划）
| 字段名 | 类型 | 必填 | 说明 | 权限 |
|---|---|---|---|---|
| id | string | 是 | 计划主键 | 家长写/学生读 |
| studentId | string | 是 | 学生标识 | 系统写，双端读 |
| parentId | string | 是 | 家长标识 | 系统写，家长读 |
| cycleDays | number | 是 | 20或30天 | 家长写/学生读 |
| dailyCap | number | 是 | 每日任务上限 | 家长写/学生读 |
| lockedByParent | boolean | 是 | 计划是否锁定 | 家长写/学生读 |
| days | array | 是 | 每日任务列表 | 双端读，家长写 |
| changeLogs | array | 是 | 变更日志 | 双端读，系统写 |
| createdAt/updatedAt/by/version | mixed | 是 | 审计字段 | 系统写，双端读 |

#### 4.1.2 checkin_v2（作业提交与审核）
| 字段名 | 类型 | 必填 | 说明 | 权限 |
|---|---|---|---|---|
| id | string | 是 | 提交记录主键 | 系统写，双端读 |
| studentId | string | 是 | 学生标识 | 系统写，双端读 |
| parentId | string | 是 | 审核家长标识 | 系统写，家长写 |
| taskId | string | 是 | 关联任务ID | 系统写，双端读 |
| sessionId | string | 否 | 关联学习会话ID | 系统写，双端读 |
| photo | string | 是 | 图片dataURL/对象URL | 学生写，家长读 |
| note | string | 否 | 学生备注 | 学生写，家长读 |
| review | enum | 是 | pending/approved/rejected | 家长写 |
| reviewNote | string | 否 | 家长批注 | 家长写 |
| createdAt/updatedAt/by/version | mixed | 是 | 审计字段 | 系统写，双端读 |

#### 4.1.3 supervision_v1（监督事件）
| 字段名 | 类型 | 必填 | 说明 | 权限 |
|---|---|---|---|---|
| id | string | 是 | 事件主键 | 系统写，双端读 |
| studentId | string | 是 | 学生标识 | 系统写，双端读 |
| sessionId | string | 是 | 学习会话ID | 系统写，双端读 |
| challengeType | enum | 是 | quiz/text/confirm | 家长配，系统写 |
| result | enum | 是 | pass/fail/timeout/system_error/exempted | 系统写，家长可改exempted |
| reasonTag | enum | 否 | toilet/network/device/other | 学生写，家长读 |
| latencySec | number | 否 | 响应耗时 | 系统写 |
| createdAt/updatedAt/by/version | mixed | 是 | 审计字段 | 系统写，双端读 |

#### 4.1.4 points_v1（积分与商城）
| 字段名 | 类型 | 必填 | 说明 | 权限 |
|---|---|---|---|---|
| id | string | 是 | 账户主键 | 系统写，双端读 |
| studentId | string | 是 | 学生标识 | 系统写，双端读 |
| balance | number | 是 | 当前积分余额 | 系统写，双端读 |
| ledgerId | string | 是 | 流水主键 | 系统写，双端读 |
| delta | number | 是 | 积分变动值 | 系统写 |
| reason | string | 是 | 变动原因 | 系统/家长写，学生读 |
| orderId | string | 否 | 兑换订单ID | 系统写，双端读 |
| orderStatus | enum | 否 | pending/approved/rejected/redeemed | 家长写 |
| createdAt/updatedAt/by/version | mixed | 是 | 审计字段 | 系统写，双端读 |

#### 4.1.5 score_v1（成绩与改错）
| 字段名 | 类型 | 必填 | 说明 | 权限 |
|---|---|---|---|---|
| id | string | 是 | 成绩记录主键 | 系统写，双端读 |
| studentId | string | 是 | 学生标识 | 系统写，双端读 |
| subject | string | 是 | 学科 | 双端写（学生提报，家长确认） |
| score | number | 是 | 分数 | 双端写，家长可修正 |
| source | string | 否 | 来源（周测/月考） | 双端写 |
| mistakeId | string | 否 | 错题ID | 系统写，双端读 |
| fixed | boolean | 否 | 是否改正 | 学生写，家长审 |
| verifiedByParent | boolean | 否 | 家长确认改正 | 家长写 |
| createdAt/updatedAt/by/version | mixed | 是 | 审计字段 | 系统写，双端读 |

### 4.2 最小权限边界说明
- 学生端仅可写：学习执行相关字段（如`note`、`reasonTag`、`fixed`），不可写系统策略与审核结论。
- 家长端可写：策略、审核、豁免、商城配置与审批字段。
- 系统写字段：主键、关联键、审计字段、重算结果，防止前端越权篡改。

---

## 5. 监督策略（可执行规则）
1) 学习会话进入后即启动随机验证池。
2) 连续2次超时未响应：本次会话标记“低可信”，该时段不计奖励分。
3) 拍照提交 + 家长审核通过，才算任务最终完成。
4) 审核驳回后24小时未整改：自动扣分并加入提醒。

### 5.1 反误伤机制（豁免与申诉）
- 异常原因标记：学生可在会话内选择异常原因（如“上厕所/网络抖动/设备卡顿/临时被家长叫离开”）。
- 家长一键豁免：家长可对单次误判事件执行“豁免”，豁免后恢复对应会话奖励资格。
- 会话重算规则：
  1) 被豁免事件不计入“连续超时”；
  2) 该时段有效学习时长按计时日志重算；
  3) 相关扣分自动回滚并写入审计流水。
- 重复误判阈值告警：同一设备24小时内出现≥3次系统异常（非用户超时）时，触发“监督策略过严/设备异常”告警，建议降低验证频率或排查设备。

### 5.2 误判处理流程（步骤）
1) 触发：系统记录 `result=timeout/fail` 并给出“异常申诉入口”。
2) 标记：学生在3分钟内选择异常原因并提交说明（可选）。
3) 审核：家长端待办出现“误判申诉”，可执行“豁免/维持判定”。
4) 重算：若豁免，系统重算该会话可信度、积分与任务状态；若维持，按原规则执行。
5) 留痕：全过程写入 `supervision_v1.events` 与 `points_v1.ledger` 审计字段。

### 5.3 异常场景示例
- 示例A（网络抖动）：
  - 场景：验证弹窗发出但网络中断导致未上报。
  - 处置：系统标记 `system_error`，不立即扣分；家长确认后一键豁免并重算会话。
- 示例B（临时离开上厕所）：
  - 场景：学生在验证时段短暂离开，超时1次。
  - 处置：学生标记“生理原因”，家长当日审核通过后该次超时不计入连续超时。

---

## 6. A/B测试点（先小流量验证）
- A/B-1：随机验证频率
  - A: 8~12分钟；B: 12~18分钟
  - 观察：有效学习时长、打断反感率
- A/B-2：奖励发放方式
  - A: 即时小奖；B: 周结大奖
  - 观察：连续完成率、拖延率
- A/B-3：计划生成方式
  - A: 系统自动分配；B: 学生提案+家长确认
  - 观察：计划执行率、临时变更率

---

## 7. 里程碑排期（评审版）
- M1（D1-D2）：信息架构/权限框架/数据模型落地
- M2（D3-D4）：计划执行+计时+拍照提交+家长审核主链路
- M3（D5）：学习看板图表 + 积分账本 + 商城兑换
- M4（D6）：成长档案 + A/B开关 + 验收与证据包

交付物：
- PRD v1（本文件）
- 页面原型草图（下一轮）
- API草案（若切后端）

---

## 8. 验收标准清单（供验收官逐条勾选）
> 验收口径：每条仅允许“通过/不通过”；不通过需附失败截图或日志路径。

### 8.1 学习看板模块
- [ ] AS-01 打开看板后可见4类指标（完成率/成绩趋势/及时率/改正率）。
- [ ] AS-02 周/月切换后图表数据随时间维度变化。
- [ ] AS-03 抽样核对1个学科：图表值与底层数据一致（误差=0）。

### 8.2 计划与执行模块
- [ ] AS-04 可生成20天与30天计划，任务总量随周期变化。
- [ ] AS-05 勾选未完成任务后，次日显示“顺延”标记。
- [ ] AS-06 计划修改后可查询变更日志（操作者/时间/变更内容）。

### 8.3 监督机制模块
- [ ] AS-07 计时支持开始/暂停/继续/结束完整闭环。
- [ ] AS-08 学习中随机验证可触发并记录事件（含响应结果）。
- [ ] AS-09 作业拍照提交后，家长端可执行通过/驳回并写批注。

### 8.4 积分奖惩与商城模块
- [ ] AS-10 完成任务后产生积分流水，余额=流水累计值。
- [ ] AS-11 积分不足时禁止兑换并提示原因。
- [ ] AS-12 兑换流程必须经家长审批后才可核销。

### 8.5 成长档案模块
- [ ] AS-13 可录入/查看身高体重并按更新时间展示。
- [ ] AS-14 可上传成长照片并按月份筛选。
- [ ] AS-15 学生仅查看、家长可编辑，权限边界生效。

### 8.6 反误伤与申诉机制
- [ ] AS-16 误判后学生可提交异常原因（如网络/设备/临时离开）。
- [ ] AS-17 家长可一键豁免，系统可重算会话可信度与积分。
- [ ] AS-18 24小时内系统异常≥3次时触发告警提示。

### 8.7 数据与审计一致性
- [ ] AS-19 `plan/checkin/supervision/points/score` 均具备主键、关联键、审计字段。
- [ ] AS-20 字段写权限与“2.权限矩阵 + 4.2最小权限边界”一致。
- [ ] AS-21 任意1条审核操作可追溯到 `by/createdAt/updatedAt/version`。
